<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Marathon: Health Checks and Task Termination</title>
    <link rel="icon" type="image/x-icon" href="/marathon/1.5/img/marathon-favicon.ico">
    <link href="//cdn.jsdelivr.net/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/marathon/1.5/css/style.css" rel="stylesheet">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-45222428-4', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/marathon">Marathon</a>
              </div>
              <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                  <li class="active">
                    <a href="/marathon/1.5/docs/">Docs</a>
                  </li>
                  <li >
                    <a href="/marathon/1.5/support.html">Support</a>
                  </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                  <li><a href="https://github.com/mesosphere/marathon">GitHub</a></li>
                </ul>
                <div class="grid" id="searchBar">
                  <div id="search">
                    <form role="search" method="get" action="/marathon/1.5/search/">
                      <input id="searchString" name="searchString"
                             placeholder="Search Marathon Docs" type="text">
                      <input id="searchButton" name="googleSearchName" type="submit" value="Search">
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
    <div class="col-sm-3">

        <h5>Getting Started</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/1.5/docs/">
                    Install Marathon
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/setup.html">
                    Setup Recommendations
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/high-availability.html">
                    High Availability Mode
                </a>
            </li>
        </ul>

        <h5>Using Marathon</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/1.5/docs/application-basics.html">
                    Application Basics
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/deployments.html">
                    Application Deployments
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/application-groups.html">
                    Application Groups
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/auth-access-ctrl.html">
                    Authorization and Access Control
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/blue-green-deploy.html">
                    Blue-Green Deployment
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/constraints.html">
                    Constraints
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/event-bus.html">
                    Event Bus
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/health-checks.html">
                    Health Checks
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/marathon-ui.html">
                    Marathon Web Interface
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/networking.html">
                    Networking
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/pods.html">
                    Pods
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/recipes.html">
                    Recipes
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/native-docker.html">
                    Provisioning Containers
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/persistent-volumes.html">
                    Stateful Applications Using Local Persistent Volumes
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/external-volumes.html">
                    Stateful Applications Using External Persistent Volumes
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/task-environment-vars.html">
                    Task Environment Variables
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/task-handling.html">
                    Task Handling
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/configure-task-handling.html">
                    Task Handling Configuration
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/secrets.html">
                    Secret Configuration
                </a>
            </li>
        </ul>

        <h5>Administration</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/1.5/docs/command-line-flags.html">
                    Command Line Flags
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/backup-restore.html">
                    Backup and Restore
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/framework-authentication.html">
                    Framework Authentication
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/high-availability.html">
                    High Availability
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/metrics.html">
                    Metrics
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/readiness-checks.html">
                    Readiness Checks
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/service-discovery-load-balancing.html">
                    Service Discovery and Load Balancing
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/ssl-basic-access-authentication.html">
                    SSL and Basic Authentication
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/native-docker-private-registry.html">
                    Using a Private Docker Registry
                </a>
            </li>
        </ul>

        <h5>Upgrading</h5>
        <ul class="list-unstyled">
          <li>
              <a href="/marathon/1.5/docs/upgrade/index.html">
                  Upgrading to a new Version
              </a>
          </li>
          <li>
              <a href="/marathon/1.5/docs/upgrade/network-api-for-apps.html">
                  Migrating Apps to the 1.5 Networking API
              </a>
          </li>
          <li>
              <a href="/marathon/1.5/docs/upgrade/network-api-migration.html">
                  Migrating Tools to the 1.5 Networking API
              </a>
          </li>
          <li>
              <a href="/marathon/1.5/docs/upgrade/versioning.html">
                  Versioning
              </a>
          </li>
        </ul>

        <h5>Troubleshooting</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/1.5/docs/waiting.html">
                   Stuck App or Pod Deployments
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/host-port.html">
                    An App Requires a Specific Host Port
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/local-cert.html">
                    Error Using HTTPS with local CA Certificate
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/auth-secret.html">
                    Error Reading Authentication Secret
                </a>
            </li>
        </ul>

        <h5>Development</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/1.5/docs/contributing.html">
                    Contributor Guidelines
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/core-architecture.html">
                    Current Marathon Development
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/plugin.html">
                    Extend Marathon with Plugins
                </a>
            </li>
            <li>
                <a href="/marathon/1.5/docs/developing-vm.html">
                    Run a Local Version of Marathon
                </a>
            </li>
        </ul>

        <h5>API Reference</h5>
        <ul class="list-unstyled">
        <li>
            <a href="/marathon/1.5/api-console/index.html">REST API Reference</a>
        </li>
        </ul>
        <h5>Docs for Previous Versions</h5>
        <ul class="list-unstyled">
            
            <li><a href="/marathon/1.6/docs">Version 1.6.x</a></li>
            
            <li><a href="/marathon/1.5/docs">Version 1.5.x</a></li>
            
            <li><a href="/marathon/1.4/docs">Version 1.4.x</a></li>
            
        </ul>
    </div>

    <div class="col-sm-9">
        <h1 id="health-checks-and-task-termination">Health Checks and Task Termination</h1>

<p>Health checks may be specified per application to be run against that
application’s tasks.</p>

<ul>
  <li>The default health check employs Mesos’ knowledge of the task state
<code class="highlighter-rouge">TASK_RUNNING =&gt; healthy</code>.</li>
  <li>Marathon provides a <code class="highlighter-rouge">health</code> member of the task resource
via the <a href="/marathon/1.5/docs/rest-api.html">REST API</a>, so you can add a
health check to your application definition.</li>
</ul>

<p>A health check is considered passing if (1) its HTTP response code is between
200 and 399 inclusive, and (2) its response is received within the
<code class="highlighter-rouge">timeoutSeconds</code> period. If a task fails more than <code class="highlighter-rouge">maxConsecutiveFailures</code>
health checks consecutively, that <a href="#task-termination">task is terminated</a>.</p>

<h2 id="mesos-level-health-checks-versus-marathon-level-health-checks">Mesos-level health checks versus Marathon-level health checks</h2>

<p>Marathon offers the following protocols for health checks. Declaring a protocol is optional: the default is <code class="highlighter-rouge">HTTP</code>.</p>

<ul>
  <li><code class="highlighter-rouge">HTTP</code></li>
  <li><code class="highlighter-rouge">HTTPS</code></li>
  <li><code class="highlighter-rouge">TCP</code></li>
  <li><code class="highlighter-rouge">COMMAND</code></li>
  <li><code class="highlighter-rouge">MESOS_HTTP</code></li>
  <li><code class="highlighter-rouge">MESOS_HTTPS</code></li>
  <li><code class="highlighter-rouge">MESOS_TCP</code></li>
</ul>

<h3 id="marathon-level-health-checks">Marathon-level health checks</h3>

<p>Marathon-level health checks (HTTP, HTTPS, and TCP) are executed by Marathon and thus test reachability from the current Marathon leader. Marathon-level health checks have several limitations:</p>

<ul>
  <li>
    <p>Marathon-level health checks create extra network traffic if the task and the scheduler are run on different nodes (this is usually the case).</p>
  </li>
  <li>
    <p>Network failures between the task and the scheduler, and port mapping misconfigurations can make a healthy task look unhealthy.</p>
  </li>
  <li>
    <p>If Marathon is managing a large number of tasks, performing health checks for every task can cause scheduler performance issues.</p>
  </li>
</ul>

<p>These limitations may be acceptable for smaller clusters with low-scale tasks, but Marathon-level health checks should not be used on large clusters with highly scaled Marathon tasks.</p>

<p><strong>Important:</strong> Marathon-based health checks are deprecated and will be removed in a future version. See the <a href="https://github.com/mesosphere/marathon/releases/tag/v1.4.0">1.4.0 release notes</a> for more information.</p>

<h3 id="mesos-level-health-checks">Mesos-level health checks</h3>

<p>Mesos-level health checks (<code class="highlighter-rouge">MESOS_HTTP</code>, <code class="highlighter-rouge">MESOS_HTTPS</code>, <code class="highlighter-rouge">MESOS_TCP</code>, and <code class="highlighter-rouge">COMMAND</code>) health checks are locally
executed by Mesos on the agent running the corresponding task and thus test reachability from the Mesos executor. Mesos-level health checks offer the following advantages over Marathon-level health checks:</p>

<ul>
  <li>
    <p>Mesos-level health checks are performed as close to the task as possible, so they are are not affected by networking failures.</p>
  </li>
  <li>
    <p>Mesos-level health checks are delegated to the agents running the tasks, so the number of tasks that can be checked can scale horizontally with the number of agents in the cluster.</p>
  </li>
</ul>

<h4 id="limitations-and-considerations">Limitations and considerations</h4>

<ul>
  <li>
    <p>Mesos-level health checks consume extra resources on the agents; moreover, there is some overhead for fork-execing a process and entering the tasks’ namespaces every time a task is checked.</p>
  </li>
  <li>
    <p>The health check processes share resources with the task that they check. Your application definition must account for the extra resources consumed by the health checks.</p>
  </li>
  <li>
    <p>Mesos-level health checks require tasks to listen on the container’s loopback interface in addition to whatever interface they require. If you run a service in production, you will want to make sure that the users can reach it.</p>
  </li>
</ul>

<h4 id="command-health-checks"><code class="highlighter-rouge">COMMAND</code> health checks</h4>

<p>You must escape any double quotes in your commands. This is required because Mesos runs the healthcheck command inside via <code class="highlighter-rouge">/bin/sh -c ""</code>.
  See the example below and <a href="https://issues.apache.org/jira/browse/MESOS-4812">MESOS-4812</a> for details.</p>

<p><em>Note:</em> Command health checks in combination with Dockerized tasks were
  broken in Mesos v0.23.0 and v0.24.0. This issue has been fixed in
  v0.23.1 and v0.24.1. See <a href="https://issues.apache.org/jira/browse/MESOS-3136">MESOS-3136</a> for
  more details.</p>

<h2 id="health-lifecycle">Health Lifecycle</h2>

<p>The application health lifecycle is represented by the finite state machine in
figure 1 below. In the diagram:</p>

<ul>
  <li><code class="highlighter-rouge">i</code> is the number of requested instances</li>
  <li><code class="highlighter-rouge">r</code> is the number of running instances</li>
  <li><code class="highlighter-rouge">h</code> is the number of healthy instances</li>
</ul>

<p class="text-center">
  <img src="/marathon/1.5/img/app-state.png" width="481" height="797" alt="" /><br />
  <em>Figure 1: The Application Health Lifecycle</em>
</p>

<h2 id="configure-health-checks">Configure health checks</h2>

<p>Declare health checks in the <code class="highlighter-rouge">healthChecks</code> parameter of your application definition.</p>

<h4 id="health-check-options">Health check options</h4>

<p>Options applicable to every protocol:</p>

<ul>
  <li><code class="highlighter-rouge">gracePeriodSeconds</code> (Optional. Default: 300): Health check failures are
ignored within this number of seconds or until the task becomes healthy for
the first time.</li>
  <li><code class="highlighter-rouge">intervalSeconds</code> (Optional. Default: 60): Number of seconds to wait between
health checks.</li>
  <li><code class="highlighter-rouge">maxConsecutiveFailures</code>(Optional. Default: 3): Number of consecutive health
check failures after which the unhealthy task should be killed.
HTTP &amp; TCP health checks: If this value is <code class="highlighter-rouge">0</code>, tasks will not be killed if
they fail the health check. Note that this semantic is different for mesos health checks e.g.
<code class="highlighter-rouge">MESOS_HTTP</code>. Here the task will be killed by mesos after failing <code class="highlighter-rouge">&gt;= maxConsecutiveFailures</code>
times. This means that setting <code class="highlighter-rouge">maxConsecutiveFailures = 0</code> will lead to task being killed immediately after
first health check fails.</li>
  <li><code class="highlighter-rouge">timeoutSeconds</code> (Optional. Default: 20): Number of seconds after which a
health check is considered a failure regardless of the response.</li>
</ul>

<p>For <code class="highlighter-rouge">MESOS_HTTP</code>, <code class="highlighter-rouge">MESOS_HTTPS</code>, <code class="highlighter-rouge">MESOS_TCP</code>, <code class="highlighter-rouge">TCP</code>, <code class="highlighter-rouge">HTTP</code> and <code class="highlighter-rouge">HTTPS</code>
health checks, either <code class="highlighter-rouge">port</code> or <code class="highlighter-rouge">portIndex</code> may be used. If none is
provided, <code class="highlighter-rouge">portIndex</code> is assumed. If <code class="highlighter-rouge">port</code> is provided, it takes
precedence overriding any <code class="highlighter-rouge">portIndex</code> option.</p>

<ul>
  <li><code class="highlighter-rouge">portIndex</code> (Optional. Default: 0): Index in this app’s <code class="highlighter-rouge">ports</code> or
<code class="highlighter-rouge">portDefinitions</code> array to be used for health requests. An index is used
so the app can use random ports, like <code class="highlighter-rouge">[0, 0, 0]</code> for example, and tasks
could be started with port environment variables like <code class="highlighter-rouge">$PORT1</code>.</li>
  <li><code class="highlighter-rouge">port</code> (Optional. Default: None): Port number to be used for health requests.</li>
</ul>

<p>The following option applies only to <code class="highlighter-rouge">MESOS_HTTP</code>, <code class="highlighter-rouge">MESOS_HTTPS</code>, <code class="highlighter-rouge">HTTP</code>, and
<code class="highlighter-rouge">HTTPS</code> health checks:</p>

<ul>
  <li><code class="highlighter-rouge">path</code> (Optional. Default: “/”): Path to endpoint exposed by the task that
will provide health  status. Example: “/path/to/health”.</li>
</ul>

<p>The following options only apply to <code class="highlighter-rouge">HTTP</code> and <code class="highlighter-rouge">HTTPS</code> health checks:</p>

<ul>
  <li><code class="highlighter-rouge">ignoreHttp1xx</code> (Optional. Default: false): Ignore HTTP informational status
codes 100 to 199. If the HTTP health check returns one of these, the result is
discarded and the health status of the task remains unchanged.</li>
</ul>

<h4 id="example-usage">Example usage</h4>

<p>HTTP:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/health"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"portIndex"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HTTP"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"gracePeriodSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w">
  </span><span class="nt">"intervalSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
  </span><span class="nt">"timeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
  </span><span class="nt">"maxConsecutiveFailures"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="nt">"ignoreHttp1xx"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>or Mesos HTTP:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/health"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"portIndex"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MESOS_HTTP"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"gracePeriodSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w">
  </span><span class="nt">"intervalSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
  </span><span class="nt">"timeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
  </span><span class="nt">"maxConsecutiveFailures"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>or secure HTTP:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/health"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"portIndex"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HTTPS"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"gracePeriodSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w">
  </span><span class="nt">"intervalSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
  </span><span class="nt">"timeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
  </span><span class="nt">"maxConsecutiveFailures"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
  </span><span class="nt">"ignoreHttp1xx"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p><em>Note:</em> HTTPS health checks do not verify the SSL certificate.</p>

<p>or TCP:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"portIndex"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TCP"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"gracePeriodSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w">
  </span><span class="nt">"intervalSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
  </span><span class="nt">"timeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
  </span><span class="nt">"maxConsecutiveFailures"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>or COMMAND:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COMMAND"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"curl -f -X GET http://$HOST:$PORT0/health"</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nt">"gracePeriodSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w">
  </span><span class="nt">"intervalSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
  </span><span class="nt">"timeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
  </span><span class="nt">"maxConsecutiveFailures"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COMMAND"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/bin/bash -c \\\"&lt;/dev/tcp/$HOST/$PORT0\\\""</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p><a name="task-termination"></a>
# Task Termination</p>

<h2 id="taskkilling">TASK_KILLING</h2>

<p>TASK_KILLING is a task state that signals that a task has received a kill request and is in the grace period. Other tools, for instance a load balancer or service discovery tool, should not route traffic to tasks in that state.</p>

<p>The <code class="highlighter-rouge">task_killing</code> feature must be enabled in order to make the state available. See the <a href="/marathon/1.5/docs/command-line-flags">Command Line Flags documentation</a> for details.</p>

<h2 id="taskkillgraceperiodseconds">taskKillGracePeriodSeconds</h2>

<p>While health checks allow you to determine when a task is unhealthy and should be terminated, the <code class="highlighter-rouge">taskKillGracePeriodSeconds</code> field allows you to set the amount of time between when the executor sends the <code class="highlighter-rouge">SIGTERM</code> message to gracefully terminate a task and when it kills it by sending <code class="highlighter-rouge">SIGKILL</code>. This field can be useful if you have a task that does not shut down immediately. If you do not set the grace period duration, the default is 3 seconds.</p>

<h2 id="example">Example</h2>

<p>The following long-running service needs a grace period of at least 6 seconds:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># A signal handler to shut down cleanly.</span>
<span class="c"># Shutdown takes at least 6 seconds! The grace period should be set higher than this.</span>
<span class="k">function </span>terminate <span class="o">{</span>
  <span class="nb">echo</span> <span class="k">$(</span>date<span class="k">)</span> Marathon requested shutdown, stopping the DB
  sleep 3
  <span class="nb">echo</span> <span class="k">$(</span>date<span class="k">)</span> Cleaning up disk
  sleep 3
  <span class="nb">echo</span> <span class="k">$(</span>date<span class="k">)</span> All <span class="k">done</span>, exiting cleanly
  <span class="nb">exit </span>0
<span class="o">}</span>

<span class="c"># catch TERM signals</span>
<span class="nb">trap </span>terminate SIGTERM

<span class="nb">echo</span> <span class="k">$(</span>date<span class="k">)</span> Long-running service running, pid <span class="nv">$$</span>
<span class="k">while </span><span class="nb">true</span>; <span class="k">do
  </span>sleep 1
<span class="k">done</span>
</code></pre>
</div>

<p>To set the necessary grace period, add the <code class="highlighter-rouge">taskKillGracePeriodSeconds</code> field to your application definition:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/foo"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"instances"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nt">"cmd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sleep 1000"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"cpus"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w">
  </span><span class="nt">"disk"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nt">"mem"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
  </span><span class="nt">"labels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"owner"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zeus"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"note"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Away from olympus"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"taskKillGracePeriodSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

    </div>
</div>

          <footer>
            <p class="text-muted">
              &copy; 2018 <a class="text-muted" href="http://mesosphere.com">Mesosphere, Inc.</a>
            </p>
          </footer>
        </div>
      </div>
    </div>
    <script src="//cdn.jsdelivr.net/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//cdn.jsdelivr.net/anchorjs/3.2.2/anchor.min.js"></script>
    <script>
        (function () {
            'use strict';
            anchors.options.placement = 'right';
            anchors.add('h2, h3, h4, h5, h6');
        })();
    </script>
  </body>
</html>