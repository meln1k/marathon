<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Marathon: Application Deployments</title>
    <link rel="icon" type="image/x-icon" href="/marathon/1.1/img/marathon-favicon.ico">
    <link href="//cdn.jsdelivr.net/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/marathon/1.1/css/style.css" rel="stylesheet">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-45222428-4', 'auto');
      ga('send', 'pageview');

    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/marathon/1.1/">Marathon</a>
              </div>
              <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                  <li class="active">
                    <a href="/marathon/1.1/docs/">Docs</a>
                  </li>
                  <li >
                    <a href="/marathon/1.1/support.html">Support</a>
                  </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                  <li><a href="https://github.com/mesosphere/marathon">GitHub</a></li>
                </ul>
                <div class="grid" id="searchBar">
                  <div id="search">
                    <form role="search" method="get" action="/marathon/1.1//search/">
                      <input id="searchString" name="searchString"
                             placeholder="Search Marathon Docs" type="text">
                      <input id="searchButton" name="googleSearchName" type="submit" value="Search">
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
  <div class="col-sm-3">
    <h5>Welcome</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/1.1/docs/">
          Getting Started
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/contributing.html">
          Contributing
        </a>
      </li>
    </ul>
    <hr>
    <h5>Guides</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/1.1/docs/application-basics.html">
          Application Basics
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/blue-green-deploy.html">
          Blue-Green Deployment
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/developing-vm.html">
          Developing Marathon in a VM
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/service-discovery-load-balancing.html">
          Discovery &amp; Load Balancing
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/ssl-basic-access-authentication.html">
          SSL &amp; Basic Authentication
        </a>
      </li>
    </ul>
    <hr>
    <h5>Reference</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/1.1/docs/application-groups.html">
          Application Groups
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/artifact-store.html">
          Artifact Store
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/command-line-flags.html">
          Command Line Flags
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/constraints.html">
          Constraints
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/deployments.html">
          Deployments
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/native-docker.html">
          Docker Containers
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/event-bus.html">
          Event Bus
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/framework-authentication.html">
          Framework Authentication
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/health-checks.html">
          Health Checks
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/high-availability.html">
          High Availability
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/ip-per-task.html">
          IP-per-task
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/marathon-ui.html">
          Marathon UI
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/metrics.html">
          Metrics
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/plugin.html">
          Plugins
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/ports.html">
          Ports
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/native-docker-private-registry.html">
          Private Docker Registries
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/recipes.html">
          Recipes
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/generated/api.html">
          REST API
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/rest-api.html">
          REST API (deprecated)
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/setup.html">
          Setup Recommendations for Marathon
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/persistent-volumes.html">
          Stateful Applications Using Local Persistent Volumes
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/task-environment-vars.html">
          Task Environment Variables
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/troubleshooting.html">
          Troubleshooting
        </a>
      </li>
    </ul>
    <hr>
    <h5>Development</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/1.1/docs/core-architecture.html">
          New Core Architecture
        </a>
      </li>
    </ul>
    <hr>
    <h5>Upgrading</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/1.1/docs/upgrade/index.html">
          Upgrading to a Newer Version
        </a>
      </li>
      <li>
        <a href="/marathon/1.1/docs/upgrade/06xto070.html">
          0.6.x to 0.7.0
        </a>
      </li>
    </ul>
  </div>
  <div class="col-sm-9">
    <h1 id="application-deployments">Application Deployments</h1>

<p>Every change in the definition of applications or groups in Marathon is performed as a deployment.
A deployment is a set of actions, that can do:</p>

<ul>
  <li>Start/Stop one or more applications</li>
  <li>Upgrade one or more applications</li>
  <li>Scale one or more applications</li>
</ul>

<p>Deployments are not instantly available - they take time. 
A deployment is active in Marathon until the deployment is finished successfully.</p>

<p>Multiple deployments can be performed at the same time, as long as one application is changed only by one deployment.
If a deployment is requested, that tries to change an application that is already being changed by another active deployment, 
the new deployment request will be rejected.</p>

<h2 id="dependencies">Dependencies</h2>

<p>Applications without dependencies can be deployed in any order without restriction.
If there are dependencies between applications, then the deployment actions will be performed in a specific order.</p>

<p class="text-center">
  <img src="/marathon/1.1/img/dependency.png" width="645" height="241" alt="" />
</p>

<p>In the example above the application <em>app</em> is dependent on the application <em>db</em>.</p>

<ul>
  <li><strong>Starting :</strong> if <em>db</em> and <em>app</em> is added to the system, <em>db</em> is started first and then <em>app</em></li>
  <li><strong>Stopping :</strong> if <em>db</em> and <em>app</em> is removed from the system, <em>app</em> is removed first and then <em>db</em></li>
  <li><strong>Upgrade :</strong> See section Rolling Restart.</li>
  <li><strong>Scaling :</strong> if <em>db</em> and <em>app</em> get scaled, <em>db</em> is scaled first and then <em>app</em></li>
</ul>

<h2 id="rolling-restarts">Rolling Restarts</h2>

<p>One of the most common problems facing developers and operators is how to roll out new versions of applications. 
At the root, this process consists of two phases: starting a set of processes with the new version and stopping the set of processes with the old version.
There are multitude of possible models how this process can be performed.</p>

<p>In Marathon there is an upgrade strategy with a minimumHealthCapacity, which is defined on application level.
The minimumHealthCapacity is a percentage which, when applied to the instance count, defines the number of healthy instances
that a certain version of the application must have at all times during update.</p>

<ul>
  <li><strong>minimumHealthCapacity == 0</strong> : all old instances can be killed, before the new version is deployed.</li>
  <li><strong>minimumHealthCapacity == 1</strong> : all instances of the new version is deployed side by side, before the old version is stopped</li>
  <li><strong>minimumHealthCapacity between 0 and 1</strong> : scale old version to minimumHealthCapacity and start the new version to minimumHealthCapacity side by side. If this is completed successfully then the new version is scaled to 100% and the old version is stopped.</li>
</ul>

<p>This gets a little bit more complex if there are dependencies.
When the applications of the example above are updated, the following actions will be performed:</p>

<ol>
  <li>Scale old application db to instance count 6</li>
  <li>Start new application of db to instance count 6</li>
  <li>Scale old application app to instance count 16</li>
  <li>Start new application of app to instance count 16</li>
  <li>Stop all instances of old app</li>
  <li>Stop all instances of old db</li>
  <li>Scale new db to instance count to 10</li>
  <li>Scale new application of app to instance count 20</li>
</ol>

<p>Please take into account that your cluster needs to have more capacity available for the update process if you choose a minimumHealthCapacity greater 0.5.
In this case more than half of the instances of the same application are run side by side.
These capacity constraints are summed up if there are dependencies. In our example, we defined 0.6 for db and 0.8 for app. 
This means that in the update case, we have 12 instances of db (6 old and 6 new) and 32 instances of app (16 old and 16 new) running side by side.</p>

<h2 id="force-a-deployment">Force a Deployment</h2>

<p>An application can be changed by only one deployment at a time.
Other changes to the application must wait until the first deployment has finished.
It is possible to break this rule by running a deployment with the force flag.
The REST interface allows the force flag for all state-changing operations.</p>

<p><strong>ATTENTION</strong>: The force flag should be used only in the case of a failed deployment!</p>

<p>If a force flag is set, then all deployments that are affected by this deployment are cancelled.
This may leave the system in an inconsistent state. Specifically, when an app is in the middle
of a rolling upgrade and the deployment is cancelled, it may end up in a state where some old and
some new tasks are running. If the new deployment does not update that app, it will stay in
that state until a future deployment is being made for that app.</p>

<p>By contrast, the only kind of deployments that can be force-updated safely are those which
affect single apps only.</p>

<p>Consequently, the only good reason to force a deployment affecting multiple apps is to correct
a failed deployment.</p>

<h2 id="a-failed-deployment">A failed Deployment</h2>

<p>A deployment consists of steps. The steps are executed one after the other.
The next step is only executed, if the previous step has finished successfully.</p>

<p>There are circumstances where a step will never finish successfully. For example:</p>

<ul>
  <li>the new application does not start correctly</li>
  <li>the new application does not become healthy</li>
  <li>a dependency of the new application was not declared and is not available</li>
  <li>the capacity of the cluster is exhausted</li>
  <li>the app uses a Docker container and the changes listed at [Running Docker Containers on Marathon]
(https://mesosphere.github.io/marathon/docs/native-docker.html) were not followed</li>
  <li>…</li>
</ul>

<p>The deployment in this case would take forever.
To heal the system, a new deployment must be applied to correct the problem with the current deployment.</p>

<h2 id="the-v2deployments-endpoint">The /v2/deployments endpoint</h2>

<p>The list of running deployments can be accessed via the <a href="rest-api.html#deployments">/v2/deployments</a> endpoint.
There are several items of information available for every deployment:</p>

<ul>
  <li>affectedApps: which applications are affected by this deployment</li>
  <li>steps: the steps to perform for this deployment</li>
  <li>currentStep: which step is actually performed</li>
</ul>

<p>Every step can have several actions. The actions inside a step are performed concurrently.
Possible actions are:</p>

<ul>
  <li><strong>ResolveArtifacts</strong> Resolve all artifacts of the application and persist it in the artifact store</li>
  <li><strong>StartApplication</strong> Start the specified application</li>
  <li><strong>StopApplication</strong> Stop the specified application</li>
  <li><strong>ScaleApplication</strong> Scale the specified application</li>
  <li><strong>RestartApplication</strong> Restart the specified application to the minimumHealthStrategy</li>
  <li><strong>KillAllOldTasksOf</strong> Kill the rest of tasks of the specified application</li>
</ul>


  </div>
</div>

          <footer>
            <p class="text-muted">
              &copy; 2016 <a class="text-muted" href="http://mesosphere.com">Mesosphere, Inc.</a>
            </p>
          </footer>
        </div>
      </div>
    </div>
    <script src="//cdn.jsdelivr.net/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//cdn.jsdelivr.net/anchorjs/3.2.2/anchor.min.js"></script>
    <script>
        (function () {
            'use strict';
            anchors.options.placement = 'right';
            anchors.add('h2, h3, h4, h5, h6');
        })();
    </script>
  </body>
</html>